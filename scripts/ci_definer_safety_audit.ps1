$cid=(docker ps --format "{{.ID}} {{.Names}}"|findstr /i "supabase_db"|select -first 1).Split(" ")[0]; if(-not $cid){throw "no supabase_db"}
$all=@{}; (docker exec -i $cid psql -U postgres -d postgres -At -c "select n.nspname||'.'||p.proname from pg_proc p join pg_namespace n on n.oid=p.pronamespace where n.nspname not in ('pg_catalog','information_schema')")|%{$all[$_.Trim()]=1}
$sd=(docker exec -i $cid psql -U postgres -d postgres -At -F "`t" -c "select n.nspname||'.'||p.proname||E'\t'||coalesce(array_to_string(p.proconfig,','),'')||E'\t'||pg_get_functiondef(p.oid) from pg_proc p join pg_namespace n on n.oid=p.pronamespace where p.prosecdef and n.nspname not in ('pg_catalog','information_schema') order by 1")
$bad=@(); foreach($r in $sd){$f,$cfg,$d=$r -split "`t",3; if($cfg -notmatch 'search_path=pg_catalog, public'){ $bad+=("$f missing search_path") }; foreach($m in ([regex]'(?<!\.)\b([a-z_][a-z0-9_]*)\s*\(').Matches($d)){ $n=$m.Groups[1].Value; if($all.ContainsKey("public.$n") -or $all.ContainsKey("rpc.$n") -or $all.ContainsKey("auth.$n") -or $all.ContainsKey("net.$n") -or $all.ContainsKey("vault.$n") -or $all.ContainsKey("graphql.$n") -or $all.ContainsKey("supabase_functions.$n")){ $bad+=("$f bare $n()") } } }
if($bad.Count){ $bad|Sort-Object -Unique|%{Write-Error $_}; exit 1 } else { Write-Host "DEF_SAFETY_OK" }
