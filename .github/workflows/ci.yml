name: CI

on:
  pull_request:

permissions:
  contents: read
  pull-requests: read

jobs:
  env-sanity:
    name: env-sanity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: env-sanity
        run: npm ci && npm run env:sanity

  main-moved-guard:
    name: main-moved-guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - run: npm run main-moved-guard
  changes:
    runs-on: ubuntu-latest
    outputs:
      docs_only: ${{ steps.set.outputs.docs_only }}
      workflows_changed: ${{ steps.set.outputs.workflows_changed }}
      foundation_changed: ${{ steps.set.outputs.foundation_changed }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            docs_only:
              - 'docs/**'
            workflows_changed:
              - '.github/workflows/**'
            foundation_changed:
              - 'supabase/foundation/**'
            products:
              - 'products/**'
            governance:
              - 'docs/truth/**'
              - '.github/workflows/**'
              - 'scripts/**'
              - 'docs/artifacts/GUARDRAILS.md'
              - 'docs/artifacts/CONTRACTS.md'
              - 'docs/artifacts/AUTOMATION.md'
              - 'docs/artifacts/SOP_WORKFLOW.md'
              - 'supabase/foundation/**'
      - id: set
        shell: pwsh
        env:
          DOCS_ONLY: ${{ steps.filter.outputs.docs_only }}
          GOVERNANCE: ${{ steps.filter.outputs.governance }}
          WORKFLOWS_CHANGED: ${{ steps.filter.outputs.workflows_changed }}
          FOUNDATION_CHANGED: ${{ steps.filter.outputs.foundation_changed }}
        run: |
          if ($env:DOCS_ONLY -eq 'true' -and $env:GOVERNANCE -ne 'true') {
            "docs_only=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          } else {
            "docs_only=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          }
          if ($env:WORKFLOWS_CHANGED -eq 'true') {
            "workflows_changed=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          } else {
            "workflows_changed=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          }
          if ($env:FOUNDATION_CHANGED -eq 'true') {
            "foundation_changed=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          } else {
            "foundation_changed=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          }
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        node-version: [16.x, 18.x, 20.x, 22.x]
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
      - run: npm ci
      - run: npm run truth-bootstrap



  db-heavy:
    needs: [changes, lane-enforcement, governance-change-template-contract]
    
    runs-on: ubuntu-latest
    steps:
      - run: echo "db-heavy (skipped on docs-only) PASS"

  governance-change-guard:
    name: governance-change-guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: governance-change-guard
        shell: pwsh
        run: |
          ./scripts/ci_governance_change_guard.ps1

  governance-change-template-contract:
    name: governance-change-template-contract
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: governance-change-template-contract
        shell: pwsh
        run: |
          ./scripts/ci_governance_change_template_contract.ps1

  proof-commit-binding:
    name: proof-commit-binding
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: proof-commit-binding
        shell: pwsh
        run: |
          ./scripts/ci_proof_commit_binding.ps1
  ci-semantic-contract:
    needs: [changes, lane-enforcement]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: ci-semantic-contract
        env:
          SEMANTIC_STRICT: ${{ needs.changes.outputs.workflows_changed }}
        run: node scripts/ci_semantic_contract.mjs

  toolchain-contract:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - run: npm run toolchain:contract
      
  qa-verify:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - run: pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/ci_qa_verify.ps1
  robot-owned-publish-guard:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - run: pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/ci_robot_owned_publish_guard.ps1
  qa-requirements-contract:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - run: pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/ci_qa_requirements_contract.ps1
  docs-push-contract:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - run: pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/ci_docs_push_contract.ps1
  handoff-commit-safety:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - run: pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/ci_handoff_commit_contract.ps1
  ship-guard:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - run: pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/ci_ship_guard_contract.ps1
  automation-contract:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - run: pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/ci_automation_contract.ps1
  toolchain-contract-supabase:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - run: npm run toolchain:contract:supabase
  waiver-rate-limit:
    name: waiver-rate-limit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - name: waiver-rate-limit
        run: node scripts/waiver_rate_limit.mjs
  waiver-debt-enforcement:
    name: waiver-debt-enforcement
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: waiver-debt-enforcement
        run: node scripts/waiver_debt_enforcement.mjs


  ci-topology-audit:
    name: ci-topology-audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - name: ci-topology-audit
        run: node scripts/ci_topology_audit.mjs

  truth-sync-enforced:
    name: truth-sync-enforced
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: npm ci
      - name: truth-sync-enforced
        run: npm run truth:sync && git diff --exit-code

  proof-manifest:
    name: proof-manifest
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: enforce LF
        shell: bash
        run: |
          git config --global core.autocrlf false
      - name: proof-manifest
        shell: pwsh
        run: |
          ./scripts/ci_proof_manifest.ps1

  robot-owned-guard:
    name: robot-owned-guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: robot-owned-guard
        shell: pwsh
        run: |
          ./scripts/ci_robot_owned_guard.ps1
  foundation-invariants:
    name: foundation-invariants
    needs: [changes, lane-enforcement]
    runs-on: ubuntu-latest
    steps:
      - name: foundation-invariants (no skip)
        run: |
          echo "foundation-invariants running..."
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: npm ci
      - run: npm run foundation:invariants

  stop-the-line:
    name: stop-the-line
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: npm ci
      - name: stop-the-line (pass-through unless simulated)
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: npm run stop-the-line
  stop-the-line-xor:
    name: stop-the-line-xor
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: npm ci
      - name: stop-the-line-xor
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: npm run stop-the-line-xor
  lane-policy-contract:
    name: lane-policy-contract
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: npm ci
      - name: lane-policy-contract
        run: node scripts/lane_policy_contract.mjs

  lane-enforcement:
    name: lane-enforcement
    runs-on: ubuntu-latest
    needs: [changes]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: lane-enforcement
        run: node scripts/lane_policy_contract.mjs

  ci-normalize-sweep:
    runs-on: ubuntu-latest
    needs: [changes]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: ci-normalize-sweep
        shell: pwsh
        run: ./scripts/ci_normalize_sweep.ps1
  ci-encoding-audit:
    name: ci-encoding-audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: ci-encoding-audit
        shell: pwsh
        run: |
          ./scripts/ci_encoding_audit.ps1



  ci-path-leak-audit:
    name: ci-path-leak-audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: ci-path-leak-audit
        shell: pwsh
        run: |
          ./scripts/ci_path_leak_audit.ps1
  required:
    needs: [env-sanity, test, toolchain-contract, toolchain-contract-supabase, automation-contract, ship-guard, handoff-commit-safety, docs-push-contract, qa-requirements-contract, robot-owned-publish-guard, qa-verify, governance-change-guard, ci-semantic-contract, proof-commit-binding, waiver-rate-limit, waiver-debt-enforcement, ci-topology-audit, truth-sync-enforced, proof-manifest, foundation-invariants, stop-the-line, stop-the-line-xor, lane-policy-contract, lane-enforcement, robot-owned-guard, ci-normalize-sweep, ci-encoding-audit, ci-path-leak-audit]
    runs-on: ubuntu-latest
    steps:
      - name: required (aggregate)
        shell: pwsh
        run: |
          "required PASS" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8

 






