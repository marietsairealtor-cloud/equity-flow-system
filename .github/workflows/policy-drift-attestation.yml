name: policy-drift-attestation

on:
  workflow_dispatch: {}
  schedule:
    - cron: '17 3 * * *'

permissions:
  contents: write

jobs:
  policy-drift-attestation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Attest GitHub policy drift (snapshot diff)
        shell: bash
        env:
          POLICY_DRIFT_TOKEN: ${{ secrets.POLICY_DRIFT_TOKEN }}
        run: |
          set -euo pipefail
          ts="$(date -u +"%Y%m%d_%H%M%SZ")"
          out="/tmp/2.16.1_policy_drift_attestation_${ts}.log"
          echo "PROOF_LOG=${out}"
          echo "WF_TOKEN_LEN=${#POLICY_DRIFT_TOKEN}" | tee -a "${out}"; echo "BRANCH=${GITHUB_REF_NAME}" | tee -a "${out}"; echo "HEAD=$(git rev-parse HEAD)" | tee -a "${out}"; node scripts/policy_drift_attest.mjs 2>&1 | tee -a "${out}"; test -s "${out}"

      - name: Upload proof log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: policy-drift-attestation-proof
          path: /tmp/2.16.1_policy_drift_attestation_*.log
          if-no-files-found: error
