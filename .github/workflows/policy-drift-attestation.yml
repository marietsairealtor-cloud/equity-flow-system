name: policy-drift-attestation
on:
  workflow_dispatch: {}
  schedule:
    - cron: '17 3 * * *'
permissions:
  contents: read
jobs:
  policy-drift-attestation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Attest GitHub policy drift (snapshot diff)
        shell: bash
        env:
          POLICY_DRIFT_TOKEN: ${{ secrets.POLICY_DRIFT_TOKEN }}
        run: |
          set -euo pipefail
          trap 'echo "ERR line=$LINENO cmd=$BASH_COMMAND"; exit 1' ERR
          set -x
          UTC="$(date -u +%Y%m%d_%H%M%SZ)"
          LOG="docs/proofs/2.16.1_policy_drift_attestation_${UTC}.log"
          mkdir -p docs/proofs
          node scripts/policy_drift_attest.mjs >"$LOG" 2>&1 || true
          cat "$LOG"
          grep -q "^OK:" "$LOG"
          test -s "$LOG"
          grep -q "^BRANCH=" "$LOG"
          grep -q "^TOKEN_SOURCE=" "$LOG"