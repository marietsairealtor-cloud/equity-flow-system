---
# GUARDRAILS — WeWeb + Supabase (Option 2: Read RPC Only)

## Glossary

* **DoD** = Definition of Done (objective proof a deliverable is complete)

---

## Prime Directive

1. Supabase is the brain. WeWeb is the window.
2. Core data is unreadable / unwritable directly from clients.
3. All reads/writes happen via **allowlisted RPCs only** (mechanically enforced in Postgres; WeWeb is not relied on for security).

**Implementation status**

* This document is normative policy.
* “What exists right now” is `docs/handoff_latest.txt` and `generated/schema.sql`.

**Security boundary**

* WeWeb limitations are **not** a security control.
* Security is enforced in Postgres via **privileges + RLS + RPC allowlists**.

---

## Architecture Boundaries

4. One intent = one RPC.
5. No business logic in WeWeb (no MAO math, precedence rules, eligibility).
6. UI state is cache only; never authorization.

---

## Data Model Invariants

7. Every tenant-scoped table has `tenant_id NOT NULL`.
8. Mutable core records have `row_version` (optimistic concurrency).
9. Payloads store `calc_version`.
10. Enums are contracts: **additive only**.

---

## Security (RLS + Privilege Firewall)

11. RLS **ON** for tenant tables (default deny).
12. No `service_role` key in WeWeb.
13. REVOKE `SELECT/INSERT/UPDATE/DELETE` on core tenant tables from `anon` and `authenticated`.
14. Only **allowlisted RPCs** are executable:

* EXECUTE revoked by default.
* EXECUTE granted narrowly and explicitly.

15. Read RPCs that touch protected tables are **SECURITY DEFINER** with:

* fixed `search_path`
* schema-qualified table references
* tenant membership re-check
* restricted output columns
* stable return envelope

---

## Tenancy Rules

16. Tenancy resolution is frozen in `docs/artifacts/CONTRACTS.md` → **Tenancy Resolution (LOCKED)**.
17. Entitlements are sourced **only** from `rpc.get_user_entitlements_v1()` (or the currently locked equivalent).
18. Internal helper functions (e.g. `current_tenant_id()`) are **not executable** by `authenticated`; they are callable only from allowlisted RPCs.

---

## Truth Files (robot-owned)

19. `docs/handoff_latest.txt` is autogenerated; **do not hand-edit**.
20. `generated/schema.sql` is autogenerated; **do not hand-edit**.
21. `generated/contracts.snapshot.json` is autogenerated; **do not hand-edit**.
22. `.gitattributes` is **robot-owned** and must match the CI guard’s expected content **byte-for-byte**; do not hand-edit.

---

## CI / Schema Drift

23. Any change to `supabase/migrations/**` **must** be accompanied by regenerated truth artifacts:

* `generated/schema.sql`
* `generated/contracts.snapshot.json`
* `docs/handoff_latest.txt`

24. If CI reports **SCHEMA DRIFT**, the only valid fix is:

* run `npm run handoff`
* commit the regenerated artifacts

---

## pgTAP Rules (ENFORCED)

25. pgTAP test files **must be SQL-only**.

* **No `DO` blocks**.
* **No PL/pgSQL**.

26. No lines may begin with `\` (psql meta-commands are forbidden).
27. Every pgTAP file must:

* declare `plan(n)` or `no_plan()`
* reach `finish()`

28. Tests must fail deterministically (no swallowed errors, no silent aborts).

---

## Encoding + Line Endings (ENFORCED)

29. **No `$$` anywhere** in repo-owned SQL (migrations, functions, tests).

* PowerShell corruption risk.
* Use **named dollar tags only**: `$fn$`, `$tap$`, `$sql$`, etc.

30. **UTF-8 without BOM** only.

* BOM (`EF BB BF`) is invalid.

31. **LF line endings only**.

* CRLF is invalid for guarded paths.

32. If encoding violations occur, the only fix is `npm run fix:encoding`.

---

## GitHub Rulesets / Required Checks

33. `main` is PR-only; no direct pushes; no bypass list.
34. Required reviews must include CODEOWNERS when applicable.
35. Required status checks:

* may be configured **only after** at least one successful run exists on `main`
* must be sourced from **GitHub Actions** (not Copilot or integrations)
* must match check names **string-exactly**

36. If required checks deadlock due to GitHub reconciliation bugs:

* temporarily disable required checks
* merge
* re-enable after fresh green runs on `main`

---

## AI Protocol

37. One objective per change. No refactors.
38. Cite `docs/artifacts/CONTRACTS.md` + `generated/schema.sql` before proposing edits.
39. Stop rule: **fix only the first failing step** until the Golden Path is green **twice**.

---

## Proof vs Publish vs Release (ENFORCED)

40. `ship` is **proof-only**.

* main only
* clean tree
* no generators
* no commit
* no push

41. Only `handoff` may generate truth artifacts.

42. Only `handoff:commit` may publish truth artifacts.

43. `handoff:commit` must be **janitor-proof**:

* If current branch is `main`, it must auto-create a PR branch.
* It must commit artifacts only on a PR branch.
* It must push the PR branch.
* It must never commit or push `main`.

44. `main` changes only via PR merge (no direct pushes).

---

## Forbidden: Dynamic SQL in Migrations

- `DO $$ ... EXECUTE ... $$` is **forbidden** in migrations.
- Migrations must be plain, deterministic SQL.
- Reason: dynamic execution causes non-deterministic privilege application across environments.

## Privilege Firewall Guardrail

- Privilege enforcement must be implemented via **forward-only migrations**.
- Retro-editing old migrations to change privilege behavior is forbidden.
- Firewall correctness is judged on **end-state invariants**, not intermediate steps.


##If a file looks valid but tooling says it’s invalid (especially JSON on Windows), suspect UTF-8 BOM first.

## BOM / Encoding Guardrail (Windows)

### Rule
All repo text files MUST be UTF-8 **without BOM**.

### Why
A UTF-8 BOM (`EF BB BF`) can make files *look* valid but break tooling that parses them (observed: `package.json` caused `npx husky init` to fail with JSON.parse errors on Windows).

### Automated prevention
A commit-time BOM gate runs automatically (Husky + lint-staged):
- Applies to staged `**/*.{json,md,yml,yaml,js,mjs,ts,tsx,sql,ps1}`
- Runs: `node scripts/lint_bom_gate.mjs`
- Blocks commits that include UTF-8 BOM or UTF-16 BOM.

### Operator hint
If a file looks valid but tooling says it’s invalid (especially JSON on Windows), suspect UTF-8 BOM first.
Use the standard repair workflow (`npm run fix:encoding`) or rewrite as UTF-8 without BOM.
