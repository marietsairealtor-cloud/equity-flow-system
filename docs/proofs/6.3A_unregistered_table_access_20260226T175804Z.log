PROOF_HEAD=d745137a000c211631be2a0633ff79af35bcba5a
PROOF_SCRIPTS_FILES=scripts/ci_proof_commit_binding.ps1
PROOF_SCRIPTS_FILE_SHA256=scripts/ci_proof_commit_binding.ps1:6f587ea8a5c11be7797cabd6ad10df93383c109a3612a89f356f2b3dd65d9eba
PROOF_SCRIPTS_HASH=ce0178bfa8774469ee797cbb450f48bda03bc02d66100de19ea4e5ea96955ab3
=== 6.3A Unregistered Table Access Gate — Proof Log ===
Date: 2026-02-26T12:57:23.1377471-05:00
Branch: 6.3A-unregistered-table-access
HEAD: d745137a000c211631be2a0633ff79af35bcba5a

STUB_GATES_ACTIVE:
  - db-heavy (conversion_trigger: 8.0)

=== Versions ===
Node: v20.18.1
pwsh: 7.5.4

=== DoD 1: Script enumerates tables in public where authenticated has SELECT/INSERT/UPDATE/DELETE ===
Container: faa3347f4b53
--- Query: authenticated privileges on public tables ---
user_profiles	SELECT
user_profiles	UPDATE

--- Query: default ACL entries granting to authenticated ---

=== DoD 2: Script cross-references against tenant_table_selector.json ===
--- tenant_table_selector.json contents ---
{
  "version": 2,
  "selector": {
    "tenant_id_column": "tenant_id",
    "required": true
  },
  "tenant_tables": [
    "user_profiles"
  ]
}

=== DoD 3: Deliberate-failure proof — gate fails naming table + privilege ===
--- Step A: Remove user_profiles from selector ---
Selector now has empty tenant_tables: []

--- Step B: Run gate — expect FAIL naming user_profiles + privilege ---
=== unregistered-table-access gate ===
unregistered-table-access: using container faa3347f4b53
unregistered-table-access: WARNING - no tables registered in docs/truth/tenant_table_selector.json
unregistered-table-access: will flag ALL accessible tables as unregistered
unregistered-table-access: registered tables = []
FAIL: authenticated has SELECT on public.user_profiles - table absent from tenant_table_selector.json
FAIL: authenticated has UPDATE on public.user_profiles - table absent from tenant_table_selector.json

--- Default ACL check (future table exposure) ---

unregistered-table-access: FAIL
Fix: add missing tables to docs/truth/tenant_table_selector.json or revoke the privilege.
Exit code: 1

--- Step C: Restore selector ---
Selector restored.

--- Step D: Run gate — expect PASS ---
=== unregistered-table-access gate ===
unregistered-table-access: using container faa3347f4b53
unregistered-table-access: registered tables = [user_profiles]
PASS: user_profiles is registered in tenant_table_selector.json (privilege: SELECT)

--- Default ACL check (future table exposure) ---

PASS: default ACL clean - no auto-grant to authenticated

unregistered-table-access: PASS
Exit code: 0

=== CI wiring verification ===
--- unregistered-table-access job definition (ci.yml) ---
  unregistered-table-access:
    name: unregistered-table-access
    needs: [changes, lane-enforcement]
    if: needs.changes.outputs.docs_only != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: unregistered-table-access
        shell: pwsh
        run: ./scripts/ci_unregistered_table_access.ps1

--- required job needs (ci.yml) ---
needs: [background-context-review, definer-safety-audit, unregistered-table-access, migration-schema-coupling, migration-rls-colocation, rls-strategy-consistent, anon-privilege-audit, job-graph-ordering, qa-scope-coverage, governance-path-coverage, deferred-proof-registry, handoff-idempotency, handoff-preconditions, env-sanity, test, toolchain-contract, toolchain-contract-supabase, automation-contract, ship-guard, handoff-commit-safety, docs-push-contract, qa-requirements-contract, robot-owned-publish-guard, qa-verify, governance-change-guard, ci-semantic-contract, proof-commit-binding, waiver-rate-limit, waiver-debt-enforcement, ci-topology-audit, truth-sync-enforced, proof-manifest, foundation-invariants, stop-the-line, stop-the-line-xor, lane-policy-contract, lane-enforcement, robot-owned-guard, ci-normalize-sweep, ci-encoding-audit, ci-path-leak-audit]

--- required_checks.json entry ---
"name": "CI / unregistered-table-access",

=== Phase 3 verification ===
semantic contract — PASS
green:once — PASS
green:twice — PASS
pr:preflight — PASS

=== RESULT ===
unregistered-table-access: PASS
